@{
    Layout = "~/Views/Shared/_LayoutPOS.cshtml";
}

@section scripts
{
    @Scripts.Render("~/bundles/Order")
    @Scripts.Render("~/bundles/CustomerModal")
    @Scripts.Render("~/bundles/ProductList")
}

<div id="OrderController" ng-controller="OrderController">
    <div class="col-md-5">
        <div class="row margin-top-10">
            <div class="col-md-12">
                <input id="txtSearchProduct" ng-init="InitListAutoCompleteProducts('#txtSearchProduct')"
                       class="form-control" placeholder="Nhập mã hoặc tên hàng hóa"
                       check-custom="CheckNumOfProduct" check-custom-message="Vui lòng chọn hàng hóa cho đơn hàng."
                       check-under="check-order"
                       ng-show="OrderForm._CanUpdate" />
            </div>
        </div>
        <div class="row margin-top-10" style="padding-right: 30px">
            <div class="col-md-12" style="max-height: 400px;box-sizing: content-box;overflow-y: scroll;">
                <table class="table table-striped table-bordered">
                    <thead>
                        <tr>
                            <th style="width: 30%"><span>Hàng hóa</span></th>
                            <th style="width: 30%"><span>Số lượng</span></th>
                            <th><span>Giá bán</span></th>
                            <th><span>Thành tiền</span></th>
                            <th ng-if="OrderForm._CanUpdate"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="item in ListProductsOrder">
                            <td>
                                <span ng-bind="item.ProductName + ' (' + item.ProductCode + ')'"></span>
                                <div class="red-sm-label row" ng-if="item.MaxQuantity != undefined">
                                    (Còn tồn <span ng-bind="item.MaxQuantity"></span>)
                                </div>
                            </td>
                            <td>
                                <div class="col-md-7 padding-left-right-5">
                                    <span ng-bind="item.Quantity" ng-if="!OrderForm._CanUpdate"></span>
                                    <input ng-if="OrderForm._CanUpdate"
                                           class="form-control" ng-model="item.Quantity" ng-change="ChangeProductQuantity(item, 0)"
                                           check-empty="" check-empty-message="Vui lòng nhập số lượng cho sản phẩm."
                                           check-range=";{{item.AllowNegative == 0 ? item.MaxQuantity : ''}}" check-range-message="Số lượng vượt quá lượng tồn kho {{item.MaxQuantity}}"
                                           check-under="check-order" />
                                </div>
                                <div class="col-md-3 padding-left-right-5 margin-top-5" ng-if="OrderForm._CanUpdate">
                                    <button class="btn btn-primary btn-tiny" style="padding-bottom: 0px" ng-click="ChangeProductQuantity(item, 1)">
                                        <i class="fa fa-sort-up" style=" font-size: 15px; margin-top: 2px"></i>
                                    </button>
                                </div>
                                <div class="col-md-2 padding-left-right-5 margin-top-5" ng-if="OrderForm._CanUpdate">
                                    <button class="btn btn-primary btn-tiny" style="padding-top: 0px" ng-click="ChangeProductQuantity(item, -1)">
                                        <i class="fa fa-sort-down" style=" font-size: 15px; margin-bottom: 2px"></i>
                                    </button>
                                </div>
                            </td>
                            <td>
                                <span ng-bind="item.Price | currency:'':0"></span>
                                <span class="help-button pull-right" ng-if="OrderForm.CustomerIsWholeSale == 1 && OrderForm._CanUpdate"
                                      ng-click="ShowDiscount($event, item)">
                                    <i class="fa fa-gift"></i>
                                </span>
                                <div class="red-sm-label row">
                                    <span ng-if="item.IsDiscountPercent == 1 && item.Discount > 0"> (Giảm giá <span ng-bind="item.Discount | number : 2"></span>%) </span>
                                    <span ng-if="item.IsDiscountPercent == 0 && item.Discount > 0"> (Giảm giá <span ng-bind="item.Discount | currency:'':0"></span> VNĐ)</span>
                                </div>
                            </td>
                            <td><span ng-bind="item.RealPrice | currency:'':0"></span></td>
                            <td ng-if="OrderForm._CanUpdate">
                                <a class="red margin-left-10" title="Xóa hàng hóa" ng-click="DeleteProductOrder(item)">
                                    <i class="fa-trash fa"></i>
                                </a>
                            </td>
                        </tr>
                        <tr ng-if="ListProductsOrder.length == 0">
                            @*Edit colspan*@
                            <td colspan="5" align="center"> Gõ mã hoặc tên hàng hóa vào hộp tìm kiếm để thêm hàng vào đơn hàng </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="divDiscount" class="popover fade" ng-class="{'in': DiscountForm.IsShowing, 'right' : DiscountForm.CurrentProduct.ProductId, 'left' : !DiscountForm.CurrentProduct.ProductId}"
                 style="display: block; width: 350px; left:-1000px" role="tooltip">
                <div style="top: 50%;" class="arrow"></div>
                <h3 class="popover-title">Giảm giá</h3>
                <div class="popover-content">
                    <div class="row">
                        <div class="col-md-5">
                            <label> Lượng giảm </label>
                        </div>
                        <div class="col-md-7">
                            <input class="form-control" ng-model="DiscountForm.Discount" ng-change="ChangeDiscount()" />
                        </div>
                    </div>
                    <div class="row margin-top-5">
                        <div class="col-md-5">
                            <label> Đơn vị giảm </label>
                        </div>
                        <div class="col-md-7">
                            <input id="rdIsDiscountPercentYes" type="radio" ng-model="DiscountForm.IsDiscountPercent" value="1" ng-change="ChangeDiscount()" />
                            <label class="font-weigth-normal" for="rdIsDiscountPercentYes">%</label>
                            &nbsp;&nbsp;
                            <input id="rdIsDiscountPercentNo" type="radio" ng-model="DiscountForm.IsDiscountPercent" value="0" ng-change="ChangeDiscount()" />
                            <label class="font-weigth-normal" for="rdIsDiscountPercentNo">VNĐ</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 margin-top-5 text-center">
                            <button class="btn" ng-click="SetPercentDiscount(5)">5%</button>
                            <button class="btn" ng-click="SetPercentDiscount(10)">10%</button>
                            <button class="btn" ng-click="SetPercentDiscount(15)">15%</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row margin-top-10 none-display">
            <div class="col-md-12">
                <table grid-data="ProductsOrder"
                       grid-data-type="table" @*table/storedprocedure*@
                       grid-data-action="getall" @*get/getall*@
                       grid-data-object="T_Trans_Order_Product" @*table name or stored procedure name*@
                       grid-filter-condition="[OrderId] = {{OrderForm.OrderId}}" @*must have [fieldname] for each colum field*@
                       grid-sort-condition="[Id] ASC" @*must have [fieldname] for each colum field*@>
                    <thead>
                        <tr>
                            <th grid-defined-colum="Id"></th>
                            <th grid-defined-colum="OrderId"></th>
                            <th grid-defined-colum="ProductId"></th>
                            <th grid-defined-colum="ProductId.ProductCode"></th>
                            <th grid-defined-colum="ProductId.ProductName"></th>
                            <th grid-defined-colum="Price"></th>
                            <th grid-defined-colum="Quantity"></th>
                            <th grid-defined-colum="Discount"></th>
                            <th grid-defined-colum="IsDiscountPercent"></th>
                        </tr>
                    </thead>
                </table>
                <div ng-init="InitListProducts()"></div>
            </div>
        </div>
    </div>

    <div class="col-md-5" style="position:fixed; bottom: 0px; background-color: #EEEEEE">
        <div class="row margin-top-10" ng-click="IsShowingPOSSummary = !IsShowingPOSSummary;">
            <h4 class="blue">
                Thông tin thanh toán
                <i class="fa fa-arrow-circle-down" ng-if="IsShowingPOSSummary" style="cursor: pointer"> </i>
                <i class="fa fa-arrow-circle-up" ng-if="!IsShowingPOSSummary" style="cursor: pointer"> </i>
            </h4>
            <div class="hr"></div>
        </div>

        <div ng-show="IsShowingPOSSummary">
            <div class="row margin-top-10">
                <div class="col-md-3">
                    <label class="control-label">Hình thức</label>
                </div>
                <div class="col-md-8">
                    <input id="rdPaymentTypeCash" type="radio" ng-model="OrderForm.PaymentType" value="1" ng-disabled="!OrderForm._CanUpdate && !OrderForm.IsEditingPaidForDebt" />
                    <label class="font-weigth-normal" for="rdPaymentTypeCash">Tiền mặt</label>
                    &nbsp;&nbsp;
                    <input id="rdPaymentTypeBank" type="radio" ng-model="OrderForm.PaymentType" value="2" ng-disabled="!OrderForm._CanUpdate && !OrderForm.IsEditingPaidForDebt" />
                    <label class="font-weigth-normal" for="rdPaymentTypeBank">CK</label>
                    &nbsp;&nbsp;
                    <input id="rdPaymentTypeCard" type="radio" ng-model="OrderForm.PaymentType" value="3" ng-disabled="!OrderForm._CanUpdate && !OrderForm.IsEditingPaidForDebt" />
                    <label class="font-weigth-normal" for="rdPaymentTypeCard">Thẻ</label>
                </div>
            </div>
            <div class="row margin-top-10">
                <div class="col-md-3">
                    <label class="control-label">Tiền hàng</label>
                </div>
                <div class="col-md-3">
                    <span ng-bind="OrderForm.Price | currency:'':0"></span>
                </div>
                <div class="col-md-3">
                    <label class="control-label">Giảm giá</label>
                </div>
                <div class="col-md-3">
                    <span ng-bind="OrderForm.DiscountAmmount | currency:'':0"></span>
                    <span class="help-button pull-right" ng-if="OrderForm.CustomerIsWholeSale == 1 && OrderForm._CanUpdate"
                          ng-click="ShowDiscount($event, OrderForm)">
                        <i class="fa fa-gift"></i>
                    </span>
                </div>
            </div>
            <div class="row margin-top-10">
                <div class="col-md-3">
                    <label class="control-label">Tổng cộng</label>
                </div>
                <div class="col-md-3">
                    <span ng-bind="OrderForm.SumMoney | currency:'':0"></span>
                </div>
                <div class="col-md-3">
                    <label class="control-label">Còn nợ</label>
                </div>
                <div class="col-md-3">
                    <span ng-bind="OrderForm.DebtMoney | currency:'':0"></span>
                </div>
            </div>
            <div class="row margin-top-10">
                <div class="col-md-3">
                    <label class="control-label">Thanh toán</label>
                </div>
                <div class="col-md-4">
                    <input class="form-control" ng-if="OrderForm._CanUpdate" ng-model="OrderForm.Paid" ng-change="ChangePaid()"
                           check-custom="CheckAllowCredit" check-custom-message="Hệ thống đang ở chế độ không cho phép bán nợ."
                           check-under="check-order" />
                    <span ng-bind="OrderForm.Paid | currency:'':0" ng-if="!OrderForm._CanUpdate && !OrderForm.IsEditingPaidForDebt"></span>
                    <input class="form-control" ng-if="!OrderForm._CanUpdate && OrderForm.IsEditingPaidForDebt"
                           ng-model="OrderForm.PaidForDebt"
                           check-under="check-order"
                           check-empty="" check-empty-message="Vui lòng nhập số tiền."
                           check-range="0;" check-range-message="Vui lòng thanh toán số dương." />
                    <button class="btn btn-warning" ng-if="!OrderForm._CanUpdate && OrderForm.IsActive == 1 && OrderForm.DebtMoney > 0 && !OrderForm.IsEditingPaidForDebt" ng-click="EditPaidForDebt()">
                        <i class="fa fa-dollar"> </i>
                        Thanh toán nợ
                    </button>
                    <button class="btn btn-primary btn-sm margin-top-5" ng-if="!OrderForm._CanUpdate && OrderForm.DebtMoney > 0 && OrderForm.IsEditingPaidForDebt" ng-click="SavePaidForDebt()">
                        <i class="fa fa-check"> </i>
                    </button>
                    <button class="btn btn-default btn-sm margin-top-5" ng-if="!OrderForm._CanUpdate && OrderForm.DebtMoney > 0 && OrderForm.IsEditingPaidForDebt" ng-click="CancelPaidForDebt()">
                        <i class="fa fa-close"> </i>
                    </button>
                </div>
                <div class="col-md-5">
                    <button class="btn btn-default btn-sm">
                        <i class="fa fa-undo"> </i>
                        Hủy
                    </button>
                    <button class="btn btn-primary btn-sm">
                        <i class="fa fa-print"> </i>
                        Lưu & In
                    </button> 
                </div>
            </div>
        </div>
        <div class="row margin-top-10" ng-click="IsShowingPOSCustomer = !IsShowingPOSCustomer;">
            <h4 class="blue">
                Thông tin hóa đơn
                <i class="fa fa-arrow-circle-down" ng-if="IsShowingPOSCustomer" style="cursor: pointer"> </i>
                <i class="fa fa-arrow-circle-up" ng-if="!IsShowingPOSCustomer" style="cursor: pointer"> </i>
            </h4>
            <div class="hr"></div>
        </div>
        <div ng-show="IsShowingPOSCustomer">
            <div class="row margin-top-10">
                <div class="col-md-3">
                    <label class="control-label">Khách hàng</label>
                </div>
                <div class="col-md-8">
                    <span ng-bind="OrderForm.CustomerName" ng-if="!OrderForm._CanUpdate"></span>
                    <div class="width-90" ng-show="OrderForm._CanUpdate">
                        <input class="form-control" ng-model="OrderForm.CustomerName"
                               autocomplete-master-table="T_Master_Customers"
                               autocomplete-colum-id="CustomerId"
                               autocomplete-colum-code="CustomerCode"
                               autocomplete-colum-name="CustomerName"
                               autocomplete-colum-additional="IsWholeSale"
                               autocomplete-condition="[IsActive] = 1"
                               autocomplete-model-id="#txtCustomerId"
                               autocomplete-model-additional="#txtIsWholeSale"
                               placeholder="Tìm khách hàng" />
                        <input id="txtCustomerId" class="none-display" ng-model="OrderForm.Customer" />
                        <input id="txtIsWholeSale" class="none-display" ng-model="OrderForm.CustomerIsWholeSale" />
                    </div>
                    <div class="width-10" ng-if="OrderForm._CanUpdate">
                        <button class="btn btn-primary btn-sm" data-toggle="modal"
                                data-target="#customerModal" ng-click="SetIsSaleCustomer('0')"
                                ng-if="CustomerFormConfig._CanCreate">
                            <i class="fa fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="row margin-top-10">
                <div class="col-md-3">
                    <label class="control-label">Ghi chú</label>
                </div>
                <div class="col-md-8">
                    <span ng-bind="OrderForm.Notes" ng-if="!OrderForm._CanUpdate"></span>
                    <textarea class="form-control" ng-model="OrderForm.Notes" ng-if="OrderForm._CanUpdate"
                              placeholder="Ghi chú cho đơn hàng"
                              check-length="500" check-length-message="Chiều dài tối ta là {0}."
                              check-under="check-order"></textarea>

                </div>
            </div>
        </div>
    </div>
    <div class="col-md-7">
        <div class="row col-md-12">
            <div class="col-md-5 margin-top-10">
                <select class="form-control input-sm" ng-model="AdditionalFilter.ProductGroup" dropdown-master-table="T_Master_ProductGroups" dropdown-value-field="ProductGroupId"
                        dropdown-name-field="GroupName" dropdown-empty-text="Tất cả nhóm hàng" dropdown-empty-value="0" ng-change="ReloadGrid('Products')"
                        dropdown-condition="[IsActive]  = 1 and [ParentId] = {{CurrentProductGroup}}"></select>
            </div>
            <div class="col-md-5 margin-top-10">
                <button class="btn btn-success btn-sm">
                    Hàng mới
                </button>
                <button class="btn btn-success btn-sm">
                    Hàng bán chạy
                </button>
            </div>
        </div>
        <div grid-data="Products"
             grid-data-type="table" @*table/storedprocedure*@
             grid-data-action="get" @*get/getall*@
             grid-data-object="T_Trans_Product_Store" @*table name or stored procedure name*@
             grid-filter-condition="[StoreId] = {{CurrentStore}} and [ProductId.IsSelling] = 1 and [ProductId.IsActive] = 1
                                    and ({{AdditionalFilter.ProductGroup}} = 0 or {{AdditionalFilter.ProductGroup}} = [ProductId.ProductGroup])" @*must have [fieldname] for each colum field*@
             grid-sort-condition="[ProductId.ProductName] ASC" @*must have [fieldname] for each colum field*@>

            <div grid-defined-colum="ProductId" class="none-display"></div>
            <div grid-defined-colum="ProductId.ProductName" class="none-display"></div>
            <div grid-defined-colum="ProductId.ProductCode" class="none-display"></div>
            <div grid-defined-colum="ProductId.Price" class="none-display"></div>
            <div grid-defined-colum="Quantity" class="none-display"></div>
            <div grid-defined-colum="ProductId.VAT" class="none-display"></div>
            <div grid-defined-colum="ProductId.AllowNegative" class="none-display"></div>

            <div ng-repeat="item in DataSet.Products.Data">
                <div class="col-md-2" style="width:20%; margin-top: 20px">
                    <a href="#" class="thumbnail" ng-click="SelectProduct(item)">
                        <img id="imgProduct" class="file-preview-image"
                             src="@Url.Action("GetProductImage", "Data")?productId={{item.ProductId}}"
                             alt="Chưa upload ảnh"
                             style="width:auto;height:110px;" />

                    </a>
                    <div class="text-center" style="margin-top: -12px">
                        <div ng-bind="item.ProductName"></div>
                        <div> Mã: <span ng-bind="item.ProductCode"></span></div>
                        <div class="bold">
                            <span ng-bind="item.Price | currency:'':0"></span> |
                            SL: <span ng-bind="item.Quantity"></span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-12" style="position: fixed; bottom: 0%; left:65%">
                <span grid-paging-for="Products"></span>
            </div>
        </div>
    </div>
    @Html.Partial("CustomerModal")
</div>